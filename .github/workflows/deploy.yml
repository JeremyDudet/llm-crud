name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
    paths:
      - "server/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to DigitalOcean
        env:
          PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          HOST: ${{ secrets.SERVER_IP }}
          USER: ${{ secrets.SERVER_USER }}
          # DB_HOST: ${{ secrets.DB_HOST }}
          # DB_PORT: ${{ secrets.DB_PORT  }}
          # POSTGRES_USER: ${{ secrets.POSTGRES_USER  }}
          # POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD  }}
          # POSTGRES_DB: ${{ secrets.POSTGRES_DB  }}
          # DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # JWT_SECRET: ${{ secrets.JWT_SECRET }}
          # OPENAI_API_KEYS: ${{ secrets.OPENAI_API_KEYS }}
          # PROD_CLIENT_URL: ${{ secrets.PROD_CLIENT_URL }}
          # STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${USER}@${HOST} '
            cd /root/llm-crud/server &&
            git pull origin main &&
            npm install &&
            npm run generate &&
            npm run push &&
            pm2 restart ecosystem.config.cjs --update-env
          '
